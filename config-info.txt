- External IP: 172.16.25.12/24

* VLAN 10 CONFIG
- VLAN10 subnet: 192.168.4.0/24
- VLAN10 gateway IP: 192.168.4.1

* VLAN 20 CONFIG
- VLAN20 subnet: 192.168.5.0/24
- VLAN20 gateway IP: 192.168.5.1

* LINUX (UBUNTU) WEBSERVER CONFIG
- 25 GB disk space
- 2048 MB RAM
- 2 CPU cores
- username: administrator password: admin123!
- installed software:
	- apache2
	- mg (text editor)
- ip address: 192.168.4.4

** SAMBA (FILESERVER)
- (following https://wiki.samba.org/index.php/Setting_up_Samba_as_a_Domain_Member)
- edit /etc/systemd/resolved.conf: DNS=192.168.4.3 Domains=adds.com
- reboot and check to make sure that /etc/resolv.conf has changed
	- note that the nameserver will be 172.0.0.53; DNS will still work
	- it should say "search adds.com" at the bottom of the file
- check DNS resolution and reverse lookup using dog
- check SRV resolution using nslookup (see guide above)
- edit /etc/samba/smb.conf:
	- workgroup = ADDS
	- realm = ADDS.COM
	- server role = member server
- edit /etc/samba/smb.conf to use rid idmap backend (see here -> https://wiki.samba.org/index.php/Idmap_config_rid)
- sudo smbcontrol all reload-config
- add this line to /etc/hosts (this information is given to the AD DC to add to the DNS config):
	192.168.4.4 samba.adds.com ubuntuwebserver
- sudo net ads join -U administrator
- append "winbind" to the "passwd" and "group" databases in /etc/nsswitch.conf (i.e., add them after "files systemd")
- sudo apt install winbind (why this is not auto-installed as a dependency of samba, i have no idea...)
- enable (sudo systemctl enable --now [service name]) the following services:
	- smbd
	- nmbd (possibly unnecessary... could disable later)
	- winbind
- sudo apt install libnss-winbind (so we can getent users and groups on the DC)
- add these to smb.conf and reload the samba config
	winbind enum users = yes
	winbind enum groups = yes	

- set up fileserver according to https://wiki.samba.org/index.php/Setting_up_a_Share_Using_Windows_ACLs:
	- add the following lines to smb.conf under the share definitions section (and reload-config):
		vfs objects = acl_xattr
		map acl inherit = yes
	- sudo mkdir -p /srv/samba/Share (make share directory)
	- add the following to smb.conf under the share definitions section (and reload-config):
		[Share]
			path = /srv/samba/Share/
			read only = no
	- from the web server, change the group owner of the Share directory from root to one of the domain groups
	- (e.g., "ADDS\Domain Admins"), so that files can be edited from windows
	- follow instructions in the link above to view and/or modify ACLs and permissions on the shared folder
	- test to make sure it works (create and modify files across connected devices)

* WINDOWS SERVER CONFIG
- 50 GB disk space
- 4096 MB (4 GB) RAM
- 4 CPU cores
- ip address: 192.168.4.3

- domain name: adds.com
- DSRM password: admin123!

** Group policies (domain: adds.com):
- Password Complexity:
	- Password must meet complexity requirements
	- Minimum password length: 8 characters

** Users:
- james (password: password123!)
- seyam (password: password123!)
- Administrator (password: admin123!)

** DNS
- ipv4 (A) RR: adds.com -> 192.168.4.3
- ipv4 (A) RR: website.com -> 192.168.4.4 (ubuntu server) and corresponding PTR record
- PTR record for 3.4.168.192.in-addr.arpa -> adds.com
- no ipv6 records yet
- configure dns forwarder: dns manager -> properties (on dns server) -> forwarders
	- you need to set this to give hosts access to the wider internet
	- i set this to 1.1.1.1 and 1.0.0.1 (cloudflare's public dns server)

** DHCP
- scope (hosts): 192.168.4.1 - 192.168.4.254
- exclusion range: 192.168.4.1 - 192.168.4.10 (these are reserved for static allocation to servers etc.)
- lease duration: 8 days (should it be shorter?)
- default gateway (router): 192.168.4.1
- dns servers: 192.168.4.3
- ipv6 not yet configured
- DHCP manager -> action -> manage authorised servers

* WINDOWS CLIENT CONFIG
- ip address: assigned by DHCP server (usually 192.168.4.11)
- login on adds.com domain with user account

* LINUX (UBUNTU) MAILSERVER CONFIG
- two processor cores
- 2GB RAM
- 25GB disk size
- static ipv4 address: 192.168.4.5
- username: administrator
- password: admin123!

** POSTFIX CONFIGURATION
- sudo apt install postfix
- select "Internet Site" in the interactive installer
- set mail name to "adds.com" in the interactive installer
- make the following changes in /etc/postfix/main.cf:
	- myhostname = mail.adds.com (sets the hostname of the server)
	- myorigin = $mydomain (sets the domain name to use in addresses (after the @); $mydomain is the parent of $myhostname,
	  i.e., adds.com)
	- mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
          (sets whitelist of domain names to receive mail for (i.e., instead of passing it on to another server))
	- mynetworks_style = subnet (sets the range of IPs from which mail can be sent; in this case, hosts on the same subnet
	  as the server. also, remove the "mynetworks = ..." line which conflicts with this setting)
	- relayhost = $mydomain (deliver mail through mail server, rather than through internet)
	  (email will be internal for now, but later we can configure external email)
	- proxy_interfaces = 172.16.25.12 (explicitly state external NAT IP address so external emails can be received)
	  (this is preparation for external email support)
	- home_mailbox = /Maildir (set mailbox path relative to a (local) user's home directory)
	- mailbox_transport = lmtp:unix:private/dovecot-lmtp (use dovecot lmtp daemon as MDA, may change this later)
- sudo systemctl reload postfix (make sure settings are valid)
- sudo postfix reload
- update /etc/aliases (forward email sent to the postmaster and root addresses to the administrator account):
	- postmaster: administrator
	- root: administrator
- sudo newaliases (commit these changes)
- sudo postfix status (make sure that postfix is running)
- on the DC, add DNS records (A and MX) for the mailserver

** DOVECOT CONFIGURATION
- sudo apt install dovecot-imapd dovecot-lmtpd
- add/uncomment the following in /etc/dovecot/dovecot.conf:
	- protocols = imap lmtp
	- shutdown_clients = yes (close active sessions when dovecot is restarted)
	- log_debug = category=auth (make dovecot log authentication events)
	- postmaster_address = postmaster@adds.com
	- mail_location = maildir:/var/mail/%u/Maildir (also comment out the corresponding setting in conf.d/10-mail.conf)
	  (also remember to add each email user to the 'mail' group)

	- service stats { (this fixes some strange issue related to dovecot statistics logging...)
		  unix_listener stats-reader {
		    group = mail
		    mode = 0666
		  }
	  unix_listener 
		stats-writer {
		    group = mail
		    mode = 0666
		  }
	}
	service anvil {
	  unix_listener anvil {
	    group = mail
	    mode = 0666
	  }
	}

	userdb { (set up user database queried by postfix, in this case, /etc/passwd)
		driver = passwd
		args = blocking=no username_format=%n (separate local part of address from domain when indexing db)
	}
- in /etc/dovecot/conf.d/10-master.conf:
	service imap-login {
		inet listener imap {
			port 143
		}
		...
	}

- sudo dovecot (start dovecot)	
- set up lmtpd:
	- in /etc/dovecot/conf.d/10-auth.conf: auth_username_format = %Ln
	- in /etc/dovecot/conf.d/10-master.conf: (set up unix socket for lmtp)
		service lmtp {
			unix_listener /var/spool/postfix/private/dovecot-lmtp {
				group = postfix
				mode = 0600
				user = postfix
			}
			...
		}

- set up firewall (ufw) to allow for remote imap and smtp connections:
	- sudo ufw enable
	- sudo ufw default deny incoming
	- sudo ufw default allow outgoing
	- sudo ufw allow smtp
	- sudo ufw allow imap

- set up authentication:
	- in /etc/dovecot/dovecot.conf:
		- passdb { driver = pam }

gateway ip: 192.168.4.1
dhcp server ip: 192.168.4.3
